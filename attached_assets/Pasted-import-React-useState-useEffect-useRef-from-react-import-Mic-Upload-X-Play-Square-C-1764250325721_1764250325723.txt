import React, { useState, useEffect, useRef } from 'react';
import { Mic, Upload, X, Play, Square, ChevronRight, Brain, Sparkles, AlertTriangle, FileText, CheckCircle2, Zap, HelpCircle, ArrowRight, ArrowLeft, Camera, VideoOff } from 'lucide-react';

/**
 * Study Companion App - Black & Yellow Edition
 * A voice-first, multimodal study aid using Gemini Flash.
 * New York Edition: No settings, distinct NYC persona.
 */

const App = () => {
  // --- State ---
  // API Key is pre-set
  const [apiKey] = useState('AIzaSyDIqg3VvdiMz7N1aJi82Ju0_X93-7RFLkI');
  const [images, setImages] = useState([]); // Array of base64 strings
  const [isListening, setIsListening] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [userTranscript, setUserTranscript] = useState('');
  const [useCamera, setUseCamera] = useState(false);
  
  // Analysis State
  const [aiResponse, setAiResponse] = useState(null); 
  const [error, setError] = useState('');

  // Quiz State
  const [quiz, setQuiz] = useState(null); // Array of questions
  const [isQuizLoading, setIsQuizLoading] = useState(false);
  const [showQuizModal, setShowQuizModal] = useState(false);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [quizScore, setQuizScore] = useState(0);
  const [selectedOption, setSelectedOption] = useState(null);
  const [quizCompleted, setQuizCompleted] = useState(false);

  // --- Refs ---
  const recognitionRef = useRef(null);
  const synthRef = useRef(window.speechSynthesis);
  const videoRef = useRef(null);

  // --- Effects ---
  useEffect(() => {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognitionRef.current = new SpeechRecognition();
      recognitionRef.current.continuous = true;
      recognitionRef.current.interimResults = true;

      recognitionRef.current.onresult = (event) => {
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          }
        }
        if (finalTranscript) {
          setUserTranscript(prev => prev + ' ' + finalTranscript);
        }
      };

      recognitionRef.current.onerror = (event) => {
        console.error("Speech recognition error", event.error);
        setIsListening(false);
      };
      
      recognitionRef.current.onend = () => {
        if (isListening) setIsListening(false);
      };
    } else {
      setError("Browser doesn't support Speech Recognition. Try Chrome.");
    }

    return () => {
      if (recognitionRef.current) recognitionRef.current.stop();
      if (synthRef.current) synthRef.current.cancel();
    };
  }, []);

  // Camera Effect
  useEffect(() => {
    let stream = null;
    if (useCamera) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(s => {
          stream = s;
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
          }
        })
        .catch(err => {
          console.error("Camera error:", err);
          setError("Could not access camera. Check permissions.");
          setUseCamera(false);
        });
    } else {
      if (videoRef.current) {
        const srcObject = videoRef.current.srcObject;
        if (srcObject) {
          srcObject.getTracks().forEach(track => track.stop());
        }
        videoRef.current.srcObject = null;
      }
    }
    return () => {
      if (stream) stream.getTracks().forEach(track => track.stop());
    };
  }, [useCamera]);

  // --- Helpers ---
  const getImageParts = () => images.map(img => ({
    inlineData: {
      mimeType: "image/jpeg",
      data: img.split(',')[1]
    }
  }));

  const callGemini = async (prompt) => {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [...getImageParts(), { text: prompt }]
        }]
      })
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    const textResponse = data.candidates[0].content.parts[0].text;
    const jsonString = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
    return JSON.parse(jsonString);
  };

  // --- Handlers ---

  const handleFileUpload = (e) => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onloadend = () => {
        const img = new Image();
        img.src = reader.result;
        img.onload = () => {
           const canvas = document.createElement('canvas');
           const MAX_WIDTH = 800;
           const scaleSize = MAX_WIDTH / img.width;
           canvas.width = MAX_WIDTH;
           canvas.height = img.height * scaleSize;
           const ctx = canvas.getContext('2d');
           ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
           setImages(prev => [...prev, canvas.toDataURL(file.type)]);
        }
      };
      reader.readAsDataURL(file);
    });
  };

  const removeImage = (index) => setImages(prev => prev.filter((_, i) => i !== index));

  const toggleListening = () => {
    if (isListening) {
      recognitionRef.current.stop();
      setIsListening(false);
    } else {
      setUserTranscript('');
      recognitionRef.current.start();
      setIsListening(true);
      setAiResponse(null);
    }
  };

  const speakText = (text) => {
    if (synthRef.current.speaking) {
      synthRef.current.cancel();
      setIsSpeaking(false);
      return;
    }
    const utterance = new SpeechSynthesisUtterance(text);
    const voices = synthRef.current.getVoices();
    // Prioritize US English voices for the "New York" text style to land better
    const preferredVoice = voices.find(v => v.lang === 'en-US' && !v.name.includes('Microsoft')) || voices.find(v => v.lang === 'en-US') || voices[0];
    if (preferredVoice) utterance.voice = preferredVoice;
    
    utterance.pitch = 0.9; // Slightly lower pitch for authority
    utterance.rate = 1.1; // Faster rate
    utterance.onstart = () => setIsSpeaking(true);
    utterance.onend = () => setIsSpeaking(false);
    synthRef.current.speak(utterance);
  };

  const analyzeExplanation = async () => {
    if (!apiKey || images.length === 0 || userTranscript.length < 10) {
      setError("Yo, I need some images and an explanation before I can work here.");
      return;
    }
    setIsProcessing(true);
    setError('');

    try {
      const prompt = `
        You are a smart, tough-love study tutor from New York City.
        Speak with a strong New York attitude and dialect (use phrases like "Listen pal", "You kiddin' me?", "Let me break it down for ya", "Fuggedaboutit", "Straight up").
        
        1. Analyze the attached study material images.
        2. Read the user's verbal explanation of the topic: "${userTranscript}".
        3. Compare the user's understanding against the material.
        4. Output a JSON object ONLY (no markdown) with this structure:
        {
          "score": number (0-100),
          "summary": "Brief 1-sentence summary of what they said (in thick NY style)",
          "missed_topics": [
            { "topic": "Name of concept", "explanation": "Detailed explanation of this concept based on the source material (in NY style)." }
          ],
          "detailed_feedback": "General feedback paragraph. Be direct, maybe a bit roasted if they missed obvious stuff, but helpful. (in NY style)."
        }
      `;
      const result = await callGemini(prompt);
      setAiResponse(result);
      speakText(`Alright, listen up. You scored ${result.score} out of 100. ${result.detailed_feedback.substring(0, 200)}...`);
    } catch (err) {
      setError("Analysis failed. " + err.message);
    } finally {
      setIsProcessing(false);
    }
  };

  const generateQuiz = async () => {
    if (images.length === 0) {
      setError("Upload materials first.");
      return;
    }
    setIsQuizLoading(true);
    try {
      const prompt = `
        Analyze the attached study materials.
        Generate a challenging 5-question multiple choice quiz to test understanding.
        Adopt the persona of a New York street tutor.
        Output JSON ONLY:
        [
          {
            "question": "Question text (New York style)",
            "options": ["Option A", "Option B", "Option C", "Option D"],
            "correctAnswer": 0, // index of correct option (0-3)
            "explanation": "Why this is the correct answer (NY style)"
          }
        ]
      `;
      const result = await callGemini(prompt);
      setQuiz(result);
      setCurrentQuestion(0);
      setQuizScore(0);
      setQuizCompleted(false);
      setSelectedOption(null);
      setShowQuizModal(true);
    } catch (err) {
      setError("Quiz generation failed. " + err.message);
    } finally {
      setIsQuizLoading(false);
    }
  };

  const handleQuizAnswer = (index) => {
    if (selectedOption !== null) return; // Prevent changing answer
    setSelectedOption(index);
    if (index === quiz[currentQuestion].correctAnswer) {
      setQuizScore(prev => prev + 1);
    }
  };

  const nextQuestion = () => {
    if (currentQuestion < quiz.length - 1) {
      setCurrentQuestion(prev => prev + 1);
      setSelectedOption(null);
    } else {
      setQuizCompleted(true);
    }
  };

  // --- Render Components ---

  // 1. Quiz Modal
  const QuizModal = () => (
    <div className="fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4 backdrop-blur-md">
      <div className="bg-neutral-900 border border-yellow-500/30 w-full max-w-2xl relative shadow-2xl">
        <button 
          onClick={() => setShowQuizModal(false)} 
          className="absolute top-4 right-4 text-neutral-500 hover:text-white"
        >
          <X className="w-6 h-6" />
        </button>
        
        <div className="p-8">
          {!quizCompleted ? (
            <>
              <div className="flex justify-between items-end mb-6 border-b border-neutral-800 pb-4">
                <h3 className="text-2xl font-bold text-white tracking-tight">STREET SMARTS CHECK</h3>
                <span className="text-yellow-500 font-mono">Q.{currentQuestion + 1}/{quiz.length}</span>
              </div>
              
              <p className="text-lg text-neutral-200 mb-8 font-medium">
                {quiz[currentQuestion].question}
              </p>

              <div className="space-y-3 mb-8">
                {quiz[currentQuestion].options.map((option, idx) => {
                  let btnClass = "border-neutral-700 hover:border-yellow-500/50 hover:bg-neutral-800";
                  if (selectedOption !== null) {
                    if (idx === quiz[currentQuestion].correctAnswer) btnClass = "bg-green-500/20 border-green-500 text-green-400";
                    else if (idx === selectedOption) btnClass = "bg-red-500/20 border-red-500 text-red-400";
                    else btnClass = "border-neutral-800 opacity-50";
                  }

                  return (
                    <button
                      key={idx}
                      onClick={() => handleQuizAnswer(idx)}
                      disabled={selectedOption !== null}
                      className={`w-full text-left p-4 border rounded-sm transition-all flex justify-between items-center group ${btnClass}`}
                    >
                      <span className="text-sm">{option}</span>
                      {selectedOption !== null && idx === quiz[currentQuestion].correctAnswer && <CheckCircle2 className="w-5 h-5" />}
                    </button>
                  );
                })}
              </div>

              {selectedOption !== null && (
                <div className="animate-in fade-in slide-in-from-bottom-4 duration-300">
                  <div className="bg-neutral-800 p-4 rounded-sm border-l-4 border-yellow-500 mb-6">
                    <p className="text-sm text-neutral-300">
                      <span className="text-yellow-500 font-bold uppercase text-xs block mb-1">Look...</span>
                      {quiz[currentQuestion].explanation}
                    </p>
                  </div>
                  <button 
                    onClick={nextQuestion}
                    className="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 rounded-sm flex items-center justify-center gap-2"
                  >
                    {currentQuestion < quiz.length - 1 ? "Next One" : "Wrap It Up"} <ArrowRight className="w-4 h-4" />
                  </button>
                </div>
              )}
            </>
          ) : (
            <div className="text-center py-12">
              <div className="w-24 h-24 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <Brain className="w-12 h-12 text-black" />
              </div>
              <h2 className="text-3xl font-bold text-white mb-2">QUIZ DONE, PAL</h2>
              <p className="text-neutral-400 mb-8">Here's how you did:</p>
              <div className="text-6xl font-bold text-yellow-500 mb-8 font-mono">{quizScore} / {quiz.length}</div>
              <button 
                onClick={() => setShowQuizModal(false)}
                className="bg-white text-black font-bold px-8 py-3 rounded-sm hover:bg-neutral-200"
              >
                Back to Work
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );

  // 2. Main Interface
  return (
    <div className="min-h-screen bg-black text-neutral-200 font-sans selection:bg-yellow-500 selection:text-black overflow-hidden relative">
      
      {/* Background Grid */}
      <div className="absolute inset-0 bg-[linear-gradient(to_right,#1a1a1a_1px,transparent_1px),linear-gradient(to_bottom,#1a1a1a_1px,transparent_1px)] bg-[size:4rem_4rem] [mask-image:radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_100%)] pointer-events-none" />

      {/* Header */}
      <header className="relative z-10 flex justify-between items-center p-6 border-b border-neutral-800 bg-black/50 backdrop-blur-md">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-yellow-500 rounded-sm flex items-center justify-center shadow-[0_0_15px_rgba(234,179,8,0.3)]">
            <Zap className="w-6 h-6 text-black fill-black" />
          </div>
          <h1 className="text-2xl font-black tracking-tighter text-white">
            NEURO<span className="text-yellow-500">STUDY</span>
          </h1>
        </div>
      </header>

      <main className={`relative z-10 max-w-7xl mx-auto p-4 lg:p-8 grid gap-8 h-[calc(100vh-88px)] ${aiResponse ? 'grid-cols-1' : 'grid-cols-1 lg:grid-cols-2'}`}>
        
        {/* LEFT COLUMN: Input & Visualization - Hidden when analyzing */}
        {!aiResponse && (
          <div className="flex flex-col gap-6 h-full overflow-y-auto pb-20 no-scrollbar">
            
            {/* 1. Upload Section */}
            <div className="bg-neutral-900/50 border border-neutral-800 rounded-sm p-6 backdrop-blur-md transition-all hover:border-yellow-500/30 group">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-xs font-bold text-yellow-500 uppercase tracking-widest flex items-center gap-2">
                  <FileText className="w-4 h-4" /> Source Material
                </h3>
                <span className="text-xs font-mono text-neutral-500">{images.length} PAGES LOADED</span>
              </div>

              <div className="grid grid-cols-4 gap-4 mb-4">
                {images.map((img, idx) => (
                  <div key={idx} className="relative aspect-[3/4] rounded-sm overflow-hidden border border-neutral-700 group/img">
                    <img src={img} alt="doc" className="w-full h-full object-cover grayscale group-hover/img:grayscale-0 transition-all" />
                    <button 
                      onClick={() => removeImage(idx)}
                      className="absolute top-1 right-1 bg-black text-white p-1 opacity-0 group-hover/img:opacity-100 transition-opacity hover:text-red-500"
                    >
                      <X className="w-3 h-3" />
                    </button>
                  </div>
                ))}
                <label className="aspect-[3/4] border-2 border-dashed border-neutral-800 hover:border-yellow-500 rounded-sm flex flex-col items-center justify-center cursor-pointer bg-neutral-900/20 hover:bg-yellow-500/5 transition-all group/upload">
                  <Upload className="w-6 h-6 text-neutral-600 group-hover/upload:text-yellow-500 mb-2 transition-colors" />
                  <span className="text-[10px] uppercase font-bold text-neutral-500">Add Page</span>
                  <input type="file" accept="image/*" multiple onChange={handleFileUpload} className="hidden" />
                </label>
              </div>
            </div>

            {/* 2. Voice/Interaction Core */}
            <div className="flex-1 min-h-[400px] flex flex-col items-center justify-center relative bg-neutral-900/30 border border-neutral-800 rounded-sm p-8 backdrop-blur-md">
              
              {/* Camera Toggle - Absolute Position */}
              <button 
                onClick={() => setUseCamera(!useCamera)}
                className="absolute top-4 right-4 text-neutral-500 hover:text-yellow-500 flex items-center gap-2 text-xs font-bold uppercase transition-colors z-30"
              >
                {useCamera ? <VideoOff className="w-4 h-4" /> : <Camera className="w-4 h-4" />}
                {useCamera ? "Disable Cam" : "Enable Face Cam"}
              </button>

              {/* Visualizer Circle */}
              <div className="relative mb-8">
                {/* Animated Rings */}
                <div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-72 h-72 border-2 border-dashed border-neutral-800 rounded-full transition-all duration-1000 ${isListening ? 'rotate-180 scale-105 border-yellow-500/30' : ''}`} />
                <div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 border border-neutral-800 rounded-full transition-all duration-1000 ${isListening ? '-rotate-180 scale-95 border-yellow-500/50' : ''}`} />
                
                {/* Core Button / Video Feed */}
                <button 
                  onClick={toggleListening}
                  className={`
                    relative z-10 w-48 h-48 rounded-full flex items-center justify-center shadow-[0_0_30px_rgba(0,0,0,0.5)] transition-all duration-300 border-4 overflow-hidden group
                    ${isListening ? 'border-yellow-400 scale-105' : 'border-neutral-800 hover:border-yellow-500/50'}
                    ${isProcessing ? 'animate-pulse border-yellow-500' : ''}
                    ${useCamera ? 'bg-black' : (isListening ? 'bg-yellow-500' : 'bg-neutral-900')}
                  `}
                >
                  {/* Camera Video */}
                  {useCamera && (
                    <video 
                      ref={videoRef} 
                      autoPlay 
                      muted 
                      playsInline 
                      className={`absolute inset-0 w-full h-full object-cover transform scale-x-[-1] transition-opacity duration-300 ${isListening ? 'opacity-80' : 'opacity-50 grayscale'}`} 
                    />
                  )}

                  {/* Icon Overlay - Shows on top of video */}
                  <div className={`relative z-20 transition-all duration-300 ${useCamera ? 'drop-shadow-lg scale-110' : ''}`}>
                    {isProcessing ? (
                      <Sparkles className="w-12 h-12 text-yellow-500 animate-spin" />
                    ) : isListening ? (
                      <div className="flex items-center gap-1">
                        <div className={`w-2 h-6 rounded-sm animate-[music_0.8s_ease-in-out_infinite] ${useCamera ? 'bg-white shadow-[0_0_10px_white]' : 'bg-black'}`} />
                        <div className={`w-2 h-10 rounded-sm animate-[music_1s_ease-in-out_infinite] ${useCamera ? 'bg-white shadow-[0_0_10px_white]' : 'bg-black'}`} />
                        <div className={`w-2 h-6 rounded-sm animate-[music_0.8s_ease-in-out_infinite] ${useCamera ? 'bg-white shadow-[0_0_10px_white]' : 'bg-black'}`} />
                      </div>
                    ) : (
                      <Mic className={`w-12 h-12 ${userTranscript ? 'text-yellow-500' : (useCamera ? 'text-white/80' : 'text-neutral-600')}`} />
                    )}
                  </div>
                  
                  {/* Camera overlay effect */}
                  {useCamera && <div className="absolute inset-0 bg-yellow-500/10 pointer-events-none mix-blend-overlay" />}
                </button>
              </div>

              <div className="text-center max-w-md z-10">
                <h2 className="text-xl font-bold text-white mb-2 uppercase tracking-tight">
                  {isListening ? "Listening..." : isProcessing ? "Crunching the Numbers..." : "Talk to Me"}
                </h2>
                <p className="text-neutral-500 text-xs font-mono uppercase tracking-widest">
                  {isListening 
                    ? "Explain it like you mean it" 
                    : userTranscript 
                      ? "Got it. Ready?" 
                      : "Tap mic & explain the topic"}
                </p>
              </div>

              {/* Actions */}
              <div className="flex gap-4 mt-8 w-full max-w-sm">
                <button 
                  onClick={() => setUserTranscript('')} 
                  className="flex-1 py-3 px-4 rounded-sm border border-neutral-800 hover:bg-neutral-800 text-neutral-400 text-xs font-bold uppercase transition-colors"
                >
                  Reset
                </button>
                <button 
                  onClick={analyzeExplanation}
                  disabled={isProcessing || !userTranscript || images.length === 0}
                  className="flex-[2] py-3 px-4 rounded-sm bg-yellow-500 hover:bg-yellow-400 disabled:opacity-50 disabled:cursor-not-allowed text-black text-xs font-bold uppercase shadow-lg shadow-yellow-500/10 transition-all flex items-center justify-center gap-2"
                >
                  {isProcessing ? 'Workin\' on it...' : 'Analyze This'}
                </button>
              </div>
               
               {error && (
                 <div className="mt-4 flex items-center gap-2 text-red-500 text-xs font-bold bg-red-950/30 border border-red-900/50 px-4 py-3 rounded-sm w-full">
                   <AlertTriangle className="w-4 h-4 flex-shrink-0" /> {error}
                 </div>
               )}
            </div>
          </div>
        )}

        {/* RIGHT COLUMN: AI Analysis & Insights - Expands when aiResponse is present */}
        <div className={`
           h-full bg-neutral-900/20 border border-neutral-800 rounded-sm p-1 overflow-hidden backdrop-blur-sm flex flex-col relative transition-all duration-500
           ${aiResponse ? 'opacity-100 translate-x-0 col-span-1' : 'opacity-50 translate-x-4 lg:opacity-100 lg:translate-x-0'}
        `}>
           {/* Back Button (Only visible in full screen analysis mode) */}
           {aiResponse && (
             <button 
               onClick={() => setAiResponse(null)}
               className="absolute top-4 left-4 z-20 bg-neutral-950/80 hover:bg-white hover:text-black text-neutral-400 p-2 rounded-full border border-neutral-700 transition-all group backdrop-blur-md"
               title="Back to Studio"
             >
               <ArrowLeft className="w-5 h-5 group-hover:-translate-x-0.5 transition-transform" />
             </button>
           )}

           {/* Quiz Generator Button */}
           {aiResponse && (
             <button 
               onClick={generateQuiz}
               disabled={isQuizLoading}
               className="absolute top-4 right-4 z-20 bg-neutral-800 hover:bg-white hover:text-black text-white text-xs font-bold px-3 py-2 rounded-sm border border-neutral-700 transition-all flex items-center gap-2"
             >
               {isQuizLoading ? <Sparkles className="w-3 h-3 animate-spin" /> : <HelpCircle className="w-3 h-3" />}
               {isQuizLoading ? "COOKIN' UP A QUIZ..." : "GENERATE QUIZ"}
             </button>
           )}

           {!aiResponse ? (
             <div className="h-full flex flex-col items-center justify-center text-neutral-600 p-8 text-center border-2 border-dashed border-neutral-800/50 m-2 rounded-sm">
               <Brain className="w-16 h-16 opacity-20 mb-4" />
               <p className="font-mono text-sm uppercase">Waiting for analysis...</p>
             </div>
           ) : (
             <div className="flex flex-col h-full bg-neutral-900 rounded-sm overflow-hidden">
               {/* Score Header */}
               <div className="bg-neutral-950 p-6 pt-16 border-b border-neutral-800 relative overflow-hidden flex-shrink-0">
                 <div className="absolute top-0 right-0 w-32 h-32 bg-yellow-500/5 rounded-full blur-3xl" />
                 
                 <div className="max-w-4xl mx-auto w-full">
                    <div className="flex items-end justify-between mb-4 relative z-10">
                      <div>
                        <h3 className="text-yellow-500 font-bold uppercase text-xs tracking-widest mb-1">Knowledge Score</h3>
                        <p className="text-neutral-400 text-xs italic">"{aiResponse.summary}"</p>
                      </div>
                      <span className="text-5xl font-black text-white tracking-tighter">{aiResponse.score}<span className="text-2xl text-neutral-600">/100</span></span>
                    </div>
                    
                    <div className="w-full bg-neutral-800 h-1 mb-1">
                      <div 
                          className="h-full bg-yellow-500 transition-all duration-1000 ease-out" 
                          style={{ width: `${aiResponse.score}%` }}
                      />
                    </div>
                 </div>
               </div>

               {/* Content Scroll - Centered Container */}
               <div className="flex-1 overflow-y-auto p-6 custom-scrollbar bg-black">
                 <div className="max-w-4xl mx-auto space-y-8 pb-10">
                   {/* Missed Topics - Enhanced */}
                   {aiResponse.missed_topics?.length > 0 && (
                     <div className="space-y-4">
                       <h4 className="text-red-500 font-bold uppercase tracking-widest text-xs flex items-center gap-2 border-b border-red-900/30 pb-2">
                         <AlertTriangle className="w-4 h-4" /> Stuff You Missed
                       </h4>
                       <div className="grid gap-3">
                         {aiResponse.missed_topics.map((item, i) => (
                           <div key={i} className="bg-red-950/10 border-l-2 border-red-500 p-4">
                             <span className="text-red-400 font-bold text-sm block mb-2">{item.topic}</span>
                             <p className="text-neutral-400 text-sm leading-relaxed">{item.explanation}</p>
                           </div>
                         ))}
                       </div>
                     </div>
                   )}

                   {/* Detailed Feedback */}
                   <div>
                     <h4 className="text-yellow-500 font-bold uppercase tracking-widest text-xs flex items-center gap-2 border-b border-yellow-900/30 pb-2 mb-4">
                       <Brain className="w-4 h-4" /> The Real Talk
                     </h4>
                     <div className="text-neutral-300 text-sm leading-7 whitespace-pre-line font-light">
                       {aiResponse.detailed_feedback}
                     </div>
                   </div>
                 </div>
               </div>
                
                {/* Footer Actions */}
               <div className="p-4 border-t border-neutral-800 bg-neutral-900 flex justify-center">
                 <div className="max-w-4xl w-full flex justify-between items-center">
                   <button 
                    onClick={() => speakText(`${aiResponse.detailed_feedback}. Listen, you missed: ${aiResponse.missed_topics.map(t => t.topic).join(', ')}`)}
                    className="flex items-center gap-2 text-neutral-400 hover:text-white text-xs font-bold uppercase px-3 py-2 rounded-sm hover:bg-neutral-800 transition-colors"
                   >
                     {isSpeaking ? <Square className="w-3 h-3 fill-current" /> : <Play className="w-3 h-3 fill-current" />}
                     {isSpeaking ? "Cut the Noise" : "Hear the Feedback"}
                   </button>
                   <div className="flex items-center gap-2 text-green-500 text-[10px] font-bold uppercase bg-green-950/20 px-3 py-1.5 rounded-full border border-green-900/30">
                      <CheckCircle2 className="w-3 h-3" />
                      Ready to Roll
                   </div>
                 </div>
               </div>
             </div>
           )}
        </div>
      </main>

      {showQuizModal && <QuizModal />}
      
      <style>{`
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #000; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #333; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #555; }
        
        @keyframes music {
          0%, 100% { height: 8px; }
          50% { height: 24px; }
        }
      `}</style>
    </div>
  );
};

export default App;